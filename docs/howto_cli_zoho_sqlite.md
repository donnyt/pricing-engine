# HOWTO: Using the CLI for Pricing and Zoho Analytics Data

This guide explains how to use the CLI to fetch data from Zoho Analytics, store it in SQLite, and run the pricing engine (with LLM reasoning support).

---

## 1. Prerequisites
- Python 3.7+
- Install dependencies:
  ```sh
  pip install -r requirements.txt
  ```
- Set up required environment variables (see below).

---

## 2. Environment Variables
Set your credentials in your shell (recommended):
```sh
export ZOHO_CLIENT_ID="your_client_id"
export ZOHO_CLIENT_SECRET="your_client_secret"
export ZOHO_REFRESH_TOKEN="your_refresh_token"
export OPENAI_API_KEY="sk-..."  # For LLM reasoning
```

---

## 3. Fetch and Save Zoho Analytics Data
Fetch a report (e.g., `pnl_sms_by_month`) and save it to SQLite:
```sh
python3 src/cli.py fetch-and-save --report pnl_sms_by_month --year 2025 --month 5
```
- Data is saved to `zoho_data.db` under the table matching the report name.

---

## 4. Preview Data
Print the first few rows of a table:
```sh
python3 src/cli.py load --report pnl_sms_by_month
```

---

## 5. Run the Pricing Pipeline CLI
You can run the pricing pipeline for all locations or a single location, for any month/year, and with LLM reasoning output.

### Parameters
- `--location` (optional): Name of a single location/building (default: all locations)
- `--month` (optional): Target month (1-12, default: current month)
- `--year` (optional): Target year (default: current year)
- `--verbose` (optional): Show LLM reasoning for each price recommendation

### Usage Examples
- **All locations, current month:**
  ```sh
  python3 src/cli.py run-pipeline
  ```
- **All locations, specific month/year:**
  ```sh
  python3 src/cli.py run-pipeline --year 2024 --month 7
  ```
- **Single location (e.g., Pacific Place), current month:**
  ```sh
  python3 src/cli.py run-pipeline --location "Pacific Place"
  ```
- **Single location, specific month/year, with LLM reasoning:**
  ```sh
  python3 src/cli.py run-pipeline --location "Pacific Place" --year 2024 --month 7 --verbose
  ```

#### LLM Reasoning Output
- Use `--verbose` to include a "Reasoning" section for each location, generated by an LLM (e.g., GPT-4o via OpenAI API).
- Make sure your `OPENAI_API_KEY` is set.
- Example output:
  ```
  Pacific Place:
    Latest Occupancy: 80%
    Breakeven Occupancy: 73%
    Published Price: 3,500,000
    Recommended Price: 3,500,000
    Reasoning: The recommended price of Rp 3,500,000 is justified given the current occupancy rate of 80%, which is above the breakeven occupancy of 73%. ...
  ```

---

## 6. Example Workflow
```sh
# Set credentials
export ZOHO_CLIENT_ID=...
export ZOHO_CLIENT_SECRET=...
export ZOHO_REFRESH_TOKEN=...
export OPENAI_API_KEY=...

# Install dependencies
pip install -r requirements.txt

# Fetch and save data
python3 src/cli.py fetch-and-save --report pnl_sms_by_month --year 2025 --month 5

# Preview data
python3 src/cli.py load --report pnl_sms_by_month

# Run pricing pipeline for a single location with LLM reasoning
python3 src/cli.py run-pipeline --location "Pacific Place" --verbose
```

---

## 7. Notes
- The CLI expects to be run from the project root directory.
- For troubleshooting, ensure your environment variables are set and dependencies are installed.
- You can add support for more reports by extending the CLI and integration code.