## Relevant Files

### Core Application Files
- `src/cli.py` - Main CLI wrapper that directs to specialized modules.
- `src/zoho_cli.py` - CLI for Zoho Analytics data management operations.
- `src/pricing_cli.py` - CLI for pricing engine operations and pipeline execution.
- `src/app.py` - Unified FastAPI application combining API endpoints and Google Chat webhook functionality.

### Data Layer
- `src/data/loader.py` - Centralized data loading service for pricing data from multiple sources.
- `src/data/storage.py` - SQLite database operations for storing and retrieving data.
- `src/data/zoho.py` - Handles data retrieval from Zoho Analytics.

### Pricing Domain
- `src/pricing/models.py` - Contains all core data models for locations, expenses, occupancy, and pricing rules.
- `src/pricing/calculator.py` - Implements the core pricing calculation logic, including breakeven price per pax, dynamic pricing multipliers, margin of safety, and min/max price enforcement.
- `src/pricing/service.py` - Service layer providing clean abstraction for pricing operations (shared by API and Google Chat app).
- `src/pricing/formatter.py` - Response formatters for different output formats (Google Chat, API JSON, etc.).
- `src/pricing/rules.py` - Module for building pricing rules from configuration and extracting target breakeven occupancy.
- `src/pricing/reasoning.py` - Module for generating LLM-based reasoning for price recommendations.

### Configuration
- `src/config/rules.py` - Configuration management for loading and validating pricing rules.
- `config/pricing_rules.yaml` - Configuration file containing pricing rules and location-specific settings.

### Utilities and Error Handling
- `src/utils/parsing.py` - Safe parsing utilities for data conversion and validation.
- `src/utils/error_handler.py` - Error handling utilities including decorators, context managers, and safe parsing functions.
- `src/exceptions/pricing_exceptions.py` - Centralized exception hierarchy for the pricing engine.

### Webhooks and API
- `src/webhooks/google_chat_router.py` - Google Chat webhook handling and command processing.
- `src/api/pricing_router.py` - API endpoints for pricing operations.

### Tests
- `tests/test_data_loader.py` - Unit tests for the data loading service.
- `tests/test_pricing_calculator.py` - Unit tests for the pricing calculator logic including smart target calculations.
- `tests/test_pricing_rules.py` - Unit tests for pricing rules configuration and smart target logic.
- `tests/test_pricing_pipeline.py` - Unit tests for the pricing pipeline integration.
- `tests/test_error_handling.py` - Unit tests for the error handling system.
- `tests/test_zoho_integration.py` - Unit tests for Zoho Analytics integration.
- `tests/test_zoho_cli_upsert.py` - Unit tests for Zoho CLI operations.
- `tests/test_zoho_upsert.py` - Unit tests for Zoho data upsert functionality.
- `tests/test_zoho_upsert_simple.py` - Unit tests for simple Zoho upsert scenarios.

### Documentation
- `docs/error_handling_strategy.md` - Comprehensive documentation for the error handling strategy.
- `docs/data_loader_refactoring.md` - Documentation of the data loader refactoring process.
- `docs/howto_cli_zoho_sqlite.md` - How-to guide for CLI and Zoho SQLite operations.

### Notes

- Unit tests should be placed in the `tests/` directory, mirroring the structure of the `src/` directory.
- Use `pytest` or another Python test runner to execute tests (e.g., `pytest tests/`).
- Smart target breakeven occupancy calculations should be thoroughly tested with various profitability scenarios.
- **Architectural Refactoring Notes:**
  - Follow SOLID principles during refactoring to maintain clean architecture
  - Each refactoring step should be tested independently before proceeding
  - Focus on real architectural problems rather than cosmetic changes
  - Preserve existing functionality while improving code organization

## Tasks

- [ ] 1.0 Set Up Project Structure and Integrations
  - [x] 1.1 Create the `src/` and `tests/` directories if they do not exist.
  - [x] 1.2 Set up a Python virtual environment and requirements file.
  - [x] 1.3 Implement Zoho Analytics integration for data retrieval.
  - [x] 1.4 Configure project for microservices framework (e.g., FastAPI or Flask).
  - [x] 1.5 Implement local data storage using SQLite3 for Zoho Analytics data to avoid repeated API calls.
  - [x] 1.6 Implement CLI and backend support for clearing and reloading Zoho Analytics data for a specific month or a range of months in the SQLite database, ensuring only the latest data for each period is present.
- [ ] 2.0 Implement Core Pricing Calculation Engine
  - [x] 2.1 Define data models for locations, expenses, occupancy, and pricing rules.
  - [x] 2.2 Implement calculation of target breakeven price per pax.
  - [x] 2.3 Apply dynamic pricing multipliers based on latest occupancy.
  - [x] 2.4 Calculate base price per pax and apply margin of safety.
  - [x] 2.5 Enforce min/max price boundaries.
  - [x] 2.6 Exclude locations named "Holding" and those with zero/null PO seats.
- [ ] 3.0 Integrate Business Rules and Dynamic Pricing Logic
  - [ ] 3.1 Implement business rules (e.g., window premium, lease duration, total pax).
  - [ ] 3.2 Allow configuration of dynamic pricing tiers and margin of safety.
  - [ ] 3.3 Ensure all required inputs are validated before calculation.
- [ ] 4.0 Develop CLI and API Interfaces
  - [x] 4.1 Implement CLI for pricing calculation and reporting.
  - [x] 4.2 Develop API endpoints for external system access (now unified in `src/app.py`).
  - [x] 4.3 Document CLI commands and API endpoints.
  - [x] 4.4 Add CLI commands to clear and reload Zoho Analytics data for a single month or a range, ensuring the database always contains the latest data for each period.
- [x] 5.0 Implement Published Price Functionality
  - [x] 5.1 Store published price for each location and month, with user, date, and reason for publishing.
  - [x] 5.2 Display published price in CLI and API output, clearly distinguishing it from the recommended price.
  - [x] 5.3 Ensure published price is persisted and can be updated or replaced for a given period.
- [x] 6.0 Output Formatting, Reporting, and LLM Reasoning Integration
  - [x] 6.1 Format output to include recommended price, manual override note, latest occupancy, breakeven occupancy %, and highlight if location is losing money.
  - [x] 6.2 Integrate LLM to generate reasoning for price recommendations.
  - [ ] 6.3 Ensure output is clear and actionable for end users.
  - [x] 6.4 Format CLI output to display recommended prices as integers with thousands separators and no decimal points for clarity.
  - [x] 6.5 Clarify breakeven occupancy concepts: distinguish between target breakeven occupancy (from config) and actual breakeven occupancy (calculated from current data).
  - [x] 6.6 Update losing money logic to use actual breakeven occupancy instead of target breakeven occupancy.
  - [x] 6.7 Update CLI and Google Chat output to display both target and actual breakeven occupancy with clear labels.
- [x] 7.0 Testing, Validation, and Documentation
  - [x] 7.1 Write unit tests for all modules and core logic.
  - [ ] 7.2 Validate calculation accuracy and business rule enforcement.
  - [ ] 7.3 Document code, configuration, and usage instructions.
- [x] 7.4 Implement Centralized Error Handling System
  - [x] 7.4.1 Create comprehensive exception hierarchy with specific exception types for different error categories.
  - [x] 7.4.2 Implement error context system with rich debugging information.
  - [x] 7.4.3 Develop error handling utilities including decorators, context managers, and safe parsing functions.
  - [x] 7.4.4 Optimize pricing pipeline with consistent error handling patterns.
  - [x] 7.4.5 Enhance parsing utilities with context-aware error handling.
  - [x] 7.4.6 Create comprehensive documentation for error handling strategy.
  - [x] 7.4.7 Write unit tests for error handling system and scenarios.
  - [ ] 7.4.8 Migrate remaining modules to use centralized error handling.
  - [ ] 7.4.9 Implement error monitoring and alerting for production deployment.
- [ ] 8.0 Integrate with Google Spaces Chat
  - [x] 8.1 Implement backend integration to receive and respond to pricing requests from Google Spaces Chat.
  - [x] 8.2 Format responses for Google Spaces, including published price, recommended price, and reasoning.
  - [ ] 8.3 Add authentication/authorization for chat-based requests if needed.
  - [ ] 8.4 Document Google Spaces Chat integration and usage for end users.
- [ ] 9.0 Implement Google Chat App (Bot) for Pricing Engine
  - [x] 9.1 Set up Google Cloud project for the Chat app and enable Google Chat API
  - [x] 9.2 Register the bot in Google Workspace and configure bot permissions
  - [x] 9.3 Scaffold `src/app.py` with a unified FastAPI web server to receive Google Chat events and serve API endpoints
  - [x] 9.4 Implement endpoint to receive and parse Google Chat messages/events in the unified app
  - [x] 9.5 Implement command parsing logic to handle `/po-price <location> [month]` and validate input
  - [x] 9.6 Integrate with the pricing engine API to fetch published price, recommended price, occupancy, breakeven %, and LLM reasoning for the requested location/month
  - [ ] 9.7 Format the response for Google Chat, including all required fields and highlights (published price, recommended price, occupancy, breakeven %, reasoning, and loss warning if applicable)
  - [ ] 9.8 Handle errors gracefully (e.g., location not found, missing data, API errors) and provide user-friendly feedback in chat
  - [ ] 9.9 Implement authentication/authorization for chat users if required (e.g., restrict to organization users)
  - [ ] 9.10 Log all requests and responses for audit and troubleshooting purposes
  - [ ] 9.11 Write unit tests for command parsing, API integration, and response formatting in `tests/test_google_chat_app.py`
  - [ ] 9.12 Document Google Chat app deployment steps, configuration, and usage instructions for end users
- [ ] 10.0 Implement Smart Target Breakeven Occupancy Feature
  - [x] 10.1 Extend Configuration System for Smart Targets
    - [x] 10.1.1 Update `config/pricing_rules.yaml` to include smart target configuration options for each location
    - [x] 10.1.2 Add `use_smart_target` boolean flag to enable/disable smart targets per location
    - [x] 10.1.3 Update `src/pricing/rules.py` to parse and validate smart target configuration
    - [x] 10.1.4 Add configuration validation to ensure smart target settings are valid
  - [x] 10.2 Implement Smart Target Calculation Logic
    - [x] 10.2.1 Create `calculate_dynamic_improvement_pct()` function in `src/pricing/calculator.py`
    - [x] 10.2.2 Implement logic for profitable locations (more aggressive targets - 3-7% reduction)
    - [x] 10.2.3 Implement logic for losing money locations (less aggressive targets - 3-10% reduction)
    - [x] 10.2.4 Add consideration of current breakeven occupancy level when determining aggressiveness
    - [x] 10.2.5 Implement fallback to static targets when smart target calculation fails
    - [x] 10.2.6 Add comprehensive error handling for smart target calculations
  - [x] 10.3 Update Pricing Calculator to Use Smart Targets
    - [x] 10.3.1 Modify `get_target_breakeven_occupancy()` function to accept actual breakeven and current occupancy parameters
    - [x] 10.3.2 Update `PricingCalculator.calculate_pricing()` to pass required parameters for smart target calculation
    - [x] 10.3.3 Integrate smart target calculation into the main pricing flow
    - [x] 10.3.4 Ensure backward compatibility with existing static target configuration
    - [x] 10.3.5 Add logging for smart target calculations to track when and how targets are calculated
  - [ ] 10.4 Enhance Output Display and Reporting
    - [x] 10.4.1 Update `PricingResult` model to include smart target information
    - [x] 10.4.2 Modify CLI output to indicate when smart targets are being used
    - [x] 10.4.3 Update Google Chat formatter to display smart target information
    - [x] 10.4.4 Add visual indicators in output to distinguish between static and smart targets
    - [x] 10.4.5 Update API responses to include smart target metadata
  - [ ] 10.5 Add Testing and Validation
    - [x] 10.5.1 Create unit tests for smart target calculation logic with various scenarios
    - [x] 10.5.2 Test profitable vs losing money location calculations
    - [x] 10.5.3 Test different breakeven occupancy levels and their impact on target aggressiveness
    - [x] 10.5.4 Validate fallback behavior when smart target calculation fails
    - [x] 10.5.5 Test configuration parsing and validation for smart target settings
    - [x] 10.5.6 Create integration tests for the complete smart target workflow
    - [x] 10.5.7 Add performance tests to ensure smart target calculations don't impact system performance

- [ ] 11.0 Architectural Refactoring and Code Organization
  - [x] 11.1 Consolidate Data Layer (High Impact, Low Risk)
    - [x] 11.1.1 Move `src/sqlite_storage.py` to `src/data/storage.py` to group data access modules
    - [x] 11.1.2 Move `src/zoho_integration.py` to `src/data/zoho.py` for consistent data layer organization
    - [x] 11.1.3 Update all import statements across the codebase to use new module paths
    - [x] 11.1.4 Verify data layer functionality after migration
    - [x] 11.1.5 Update tests to use new import paths
    - [x] 11.1.6 **Comprehensive Testing Phase 1:**
      - [x] 11.1.6.1 Test CLI functionality: `python3 src/pricing_cli.py run-pipeline --location "Pacific Place" --verbose`
      - [x] 11.1.6.2 Test CLI functionality: `python3 src/zoho_cli.py fetch-and-save --report pnl_sms_by_month --year 2025 --month 5`
      - [x] 11.1.6.3 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing/Pacific%20Place"`
      - [x] 11.1.6.4 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing"`
      - [x] 11.1.6.5 Test Google Chat integration: Send `/po-price Pacific Place` via Google Chat
      - [x] 11.1.6.6 Verify all data loading operations work correctly with new module paths
      - [x] 11.1.6.7 Run full test suite: `pytest tests/`
  - [x] 11.2 Extract Configuration Management (Low Impact, Low Risk)
    - [x] 11.2.1 Create `src/config/` package with `__init__.py`
    - [x] 11.2.2 Extract `load_pricing_rules()` function from `src/po_pricing_engine.py` to `src/config/rules.py`
    - [x] 11.2.3 Update all imports to use `src.config.rules.load_pricing_rules`
    - [x] 11.2.4 Remove the test script portion from `src/po_pricing_engine.py`
    - [x] 11.2.5 Verify configuration loading works correctly after extraction
    - [x] 11.2.6 **Comprehensive Testing Phase 2:**
      - [x] 11.2.6.1 Test CLI functionality: `python3 src/pricing_cli.py run-pipeline --location "Pacific Place" --verbose`
      - [x] 11.2.6.2 Test CLI functionality: `python3 src/pricing_cli.py check-pricing --year 2024 --month 7`
      - [x] 11.2.6.3 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing/Pacific%20Place"`
      - [x] 11.2.6.4 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing"`
      - [x] 11.2.6.5 Test Google Chat integration: Send `/po-price Pacific Place` via Google Chat
      - [x] 11.2.6.6 Verify pricing rules are loaded correctly from new config module
      - [x] 11.2.6.7 Verify smart target calculations still work with new config structure
      - [x] 11.2.6.8 Run full test suite: `pytest tests/`
  - [x] 11.3 Move LLM Reasoning to Pricing Domain (Medium Impact, Low Risk)
    - [x] 11.3.1 Move `src/llm_reasoning.py` to `src/pricing/reasoning.py` as it's pricing-specific business logic
    - [x] 11.3.2 Update all import statements to use `src.pricing.reasoning.generate_llm_reasoning`
    - [x] 11.3.3 Update tests to use new import path
    - [x] 11.3.4 Verify LLM reasoning functionality after migration
    - [x] 11.3.5 **Comprehensive Testing Phase 3:**
      - [x] 11.3.5.1 Test CLI functionality: `python3 src/pricing_cli.py run-pipeline --location "Pacific Place" --verbose`
      - [x] 11.3.5.2 Test CLI functionality: `python3 src/pricing_cli.py check-pricing --year 2024 --month 7`
      - [x] 11.3.5.3 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing/Pacific%20Place"`
      - [x] 11.3.5.4 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing"`
      - [x] 11.3.5.5 Test Google Chat integration: Send `/po-price Pacific Place` via Google Chat
      - [x] 11.3.5.6 Verify LLM reasoning is generated correctly in all outputs
      - [x] 11.3.5.7 Verify reasoning appears in CLI verbose mode, API responses, and Google Chat
      - [x] 11.3.5.8 Run full test suite: `pytest tests/`
  - [x] 11.4 Integrate Pipeline Logic into Service Layer (High Impact, Medium Risk)
    - [x] 11.4.1 Analyze `src/pricing_pipeline.py` to identify core business logic vs orchestration
    - [x] 11.4.2 Move core processing logic from `run_pricing_pipeline()` into `PricingService._run_pipeline()`
    - [x] 11.4.3 Update `PricingService` to handle the full pipeline orchestration internally
    - [x] 11.4.4 Ensure `PricingService` maintains the same interface for API and CLI consumers
    - [x] 11.4.5 Update CLI and API code to use the enhanced `PricingService` directly
    - [x] 11.4.6 Remove `src/pricing_pipeline.py` after successful integration
    - [x] 11.4.7 Update tests to use `PricingService` instead of pipeline function
    - [x] 11.4.8 Verify all existing functionality works correctly after integration
    - [x] 11.4.9 **Comprehensive Testing Phase 4:**
      - [x] 11.4.9.1 Test CLI functionality: `python3 src/pricing_cli.py run-pipeline --location "Pacific Place" --verbose`
      - [x] 11.4.9.2 Test CLI functionality: `python3 src/pricing_cli.py run-pipeline` (all locations)
      - [x] 11.4.9.3 Test CLI functionality: `python3 src/pricing_cli.py check-pricing --year 2024 --month 7`
      - [x] 11.4.9.4 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing/Pacific%20Place"`
      - [x] 11.4.9.5 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing"`
      - [x] 11.4.9.6 Test Google Chat integration: Send `/po-price Pacific Place` via Google Chat
      - [x] 11.4.9.7 Test Google Chat integration: Send `/po-price Pacific Place 2024-07` via Google Chat
      - [x] 11.4.9.8 Verify all pricing calculations produce identical results to before refactoring
      - [x] 11.4.9.9 Verify published prices are still displayed correctly in all outputs
      - [x] 11.4.9.10 Verify smart target calculations still work correctly
      - [x] 11.4.9.11 Verify error handling works correctly in all interfaces
      - [x] 11.4.9.12 Run full test suite: `pytest tests/`
  - [x] 11.5 Clean Up Legacy Files (Low Impact, Low Risk)
    - [x] 11.5.1 Remove `src/po_pricing_engine.py` after extracting its functions
    - [x] 11.5.2 Update any remaining references to legacy modules
    - [x] 11.5.3 Verify no broken imports remain in the codebase
    - [x] 11.5.4 Run full test suite to ensure no regressions
    - [x] 11.5.5 **Comprehensive Testing Phase 5:**
      - [x] 11.5.5.1 Test CLI functionality: `python3 src/pricing_cli.py run-pipeline --location "Pacific Place" --verbose`
      - [x] 11.5.5.2 Test CLI functionality: `python3 src/pricing_cli.py check-pricing --year 2024 --month 7`
      - [x] 11.5.5.3 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing/Pacific%20Place"`
      - [x] 11.5.5.4 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing"`
      - [x] 11.5.5.5 Test Google Chat integration: Send `/po-price Pacific Place` via Google Chat
      - [x] 11.5.5.6 Verify no import errors occur in any module
      - [x] 11.5.5.7 Verify all functionality works exactly as before cleanup
      - [x] 11.5.5.8 Run full test suite: `pytest tests/`
  - [x] 11.6 Update Documentation and File References
    - [x] 11.6.1 Update the "Relevant Files" section in this document to reflect new structure
    - [x] 11.6.2 Update any README files or documentation that reference moved files
    - [x] 11.6.3 Update import examples in documentation
    - [x] 11.6.4 Verify all documentation is accurate after refactoring
    - [x] 11.6.5 **Final Comprehensive Testing:**
      - [x] 11.6.5.1 Test CLI functionality: `python3 src/pricing_cli.py run-pipeline --location "Pacific Place" --verbose`
      - [x] 11.6.5.2 Test CLI functionality: `python3 src/pricing_cli.py check-pricing --year 2024 --month 7`
      - [x] 11.6.5.3 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing/Pacific%20Place"`
      - [x] 11.6.5.4 Test Web API: `curl -X GET "http://localhost:8000/api/v1/pricing"`
      - [x] 11.6.5.5 Test Google Chat integration: Send `/po-price Pacific Place` via Google Chat
      - [x] 11.6.5.6 Test Google Chat integration: Send `/po-price Pacific Place 2024-07` via Google Chat
      - [x] 11.6.5.7 Verify all documentation examples work correctly
      - [x] 11.6.5.8 Run full test suite: `pytest tests/`
      - [x] 11.6.5.9 Perform end-to-end testing with real data to ensure no regressions
